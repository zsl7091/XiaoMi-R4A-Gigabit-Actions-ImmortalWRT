name: Build ImmortalWrt 24.10 (Ubuntu Host)

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-24.10
  DIY_SH: diy.sh
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04  # 宿主机环境

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Initialization Environment
        run: |
          # 1. 安装依赖需要 root 权限，所以加 sudo
          sudo apt update
          sudo apt install -y build-essential curl wget git python3
          
          # 2. 执行官方初始化脚本（内部会自动处理 sudo 逻辑）
          curl -fsSL build-scripts.immortalwrt.org | sudo bash
          
          # 3. 设置系统时区
          sudo timedatectl set-timezone "$TZ"

      - name: Clone Source Code
        run: |
          # 克隆源码（普通用户操作，不加 sudo）
          git clone $REPO_URL -b $REPO_BRANCH --single-branch --filter=blob:none openwrt

      - name: Apply Custom Configuration
        run: |
          # 复制脚本到源码目录
          [ -f $DIY_SH ] && cp $DIY_SH openwrt/
          [ -f .config ] && cp .config openwrt/ || echo "Warning: No .config found"

      - name: Update & Install Feeds
        working-directory: ./openwrt
        run: |
          # 普通用户执行
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Run DIY Script (Patch DTS)
        working-directory: ./openwrt
        run: |
          # 普通用户执行
          chmod +x $DIY_SH
          ./$DIY_SH

      - name: Download Packages
        working-directory: ./openwrt
        run: |
          # 普通用户执行
          make defconfig
          make download -j8

      - name: Compile Firmware
        working-directory: ./openwrt
        run: |
          # 核心编译步骤：普通用户执行，严禁加 sudo
          echo "Using $(nproc) threads to compile"
          make -j$(nproc) || make -j1 V=s

      - name: Organize Files
        id: organize
        working-directory: ./openwrt
        run: |
          mkdir -p ./artifact/
          # 查找生成的小米4A千兆版固件
          find bin/targets/ramips/mt7621/ -type f -name "*sysupgrade.bin" -exec cp -f {} ./artifact/ \;
          echo "FIRMWARE_PATH=$PWD/artifact" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date +'%Y%m%d%H%M')" >> $GITHUB_ENV

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt_Mi4A_GI_${{ env.BUILD_DATE }}
          path: ${{ env.FIRMWARE_PATH }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: Mi4A_GI_${{ env.BUILD_DATE }}
          files: ${{ env.FIRMWARE_PATH }}/*
          body: |
            ### 小米 4A 千兆版 (24.10)
            - 状态：编译成功
            - 分区：16MB Breed 布局 (0x50000)
            - 注意：此固件使用 Ubuntu 普通用户环境编译，符合官方规范。
