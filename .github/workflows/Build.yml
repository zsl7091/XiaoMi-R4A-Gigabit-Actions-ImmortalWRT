name: Build ImmortalWrt 24.10

on:
  workflow_dispatch:

env:
  # 已经更正并核对：必须包含 https:// 协议头
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-24.10
  DIY_SH: diy.sh
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Initialization Environment
        run: |
          sudo rm -rf /usr/share/dotnet /usr/share/swift /opt/ghc /opt/hostedtoolcache /usr/local/lib/android /opt/az
          sudo apt update
          # 移除了不存在的 handle 包，保留 2025 年编译必须的依赖
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev libz-dev patch python3 python3-pip python3-ply \
          python3-setuptools qemu-utils quilt subversion swig zlib1g-dev libelf-dev libglib2.0-dev \
          libltdl-dev libtool lrzsz scons upx-ucl unzip wget xz-utils zip bash ca-certificates \
          curl fastjar lib32gcc-s1 libc6-dev-i386 mkisofs msmtp nano rsync texinfo
          
          sudo timedatectl set-timezone "$TZ"

      - name: Clone Source Code
        run: |
          # 明确使用环境变量中的完整 URL 进行克隆
          git clone $REPO_URL -b $REPO_BRANCH --single-branch --filter=blob:none openwrt

      - name: Apply Custom Configuration
        run: |
          # 只有当前仓库存在该文件时才执行复制，避免报错
          [ -f $DIY_SH ] && cp $DIY_SH openwrt/
          [ -f .config ] && cp .config openwrt/ || echo "Warning: .config not found"

      - name: Update & Install Feeds
        working-directory: ./openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Run DIY Script
        working-directory: ./openwrt
        run: |
          chmod +x $DIY_SH
          ./$DIY_SH

      - name: Download Packages
        working-directory: ./openwrt
        run: |
          # 1. 仅补全依赖，不重新生成配置
          # 2. 直接下载当前配置所需的源码包
          make download -j8
          find dl -size -1024c -exec rm -f {} \;

      - name: Compile Firmware
        working-directory: ./openwrt
        run: |
          # 检查 .config 是否被意外篡改（可选）
          grep "CONFIG_TARGET.*DEVICE.*=y" .config
          
          echo "Using $(nproc) threads to compile"
          # 关键修改：在 make 命令后直接带上参数
          # IGNORE_ERRORS=m 表示即使某些选为 <M> 的包编译失败，也不要停止，继续生成内核和固件
          make -j$(nproc) IGNORE_ERRORS=m || make -j1 V=s IGNORE_ERRORS=m
          
      - name: Organize Files
        id: organize
        working-directory: ./openwrt
        run: |
          mkdir -p ./artifact/
          # 提取 sysupgrade 固件
          find bin/targets/ramips/mt7621/ -type f -name "*sysupgrade.bin" -exec cp -f {} ./artifact/ \;
          echo "FIRMWARE_PATH=$PWD/artifact" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date +'%Y%m%d%H%M')" >> $GITHUB_ENV

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt_Mi4A_GI_${{ env.BUILD_DATE }}
          path: ${{ env.FIRMWARE_PATH }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: Mi4A_GI_${{ env.BUILD_DATE }}
          files: ${{ env.FIRMWARE_PATH }}/*
          body: |
            ### 小米 4A 千兆版 (ImmortalWrt 24.10)
            - 源码地址: github.com
            - 闪存分区: Breed 16MB 布局 (0x50000 偏移)
            - 编译时间: ${{ env.BUILD_DATE }}
