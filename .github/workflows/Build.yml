name: Build ImmortalWrt 24.10

on:
  workflow_dispatch:

env:
  REPO_URL: github.com
  REPO_BRANCH: openwrt-24.10
  DIY_SH: diy.sh
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: debian:11
      options: --user root

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Initialize Environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt update
          # 先安装基础工具，确保 curl 和 ca-certificates 正常工作
          apt install -y curl ca-certificates git sudo

          # 针对官方脚本的“防挂”处理：先下载，再执行
          # 这样如果下载到的是 HTML 错误页，脚本会报错停止，而不是尝试运行它
          curl -fsSL https://build-scripts.immortalwrt.org/init_build_environment.sh -o init_env.sh
          
          # 检查文件是否为真正的脚本（避开 HTML 404 页面）
          if grep -q "DOCTYPE html" init_env.sh; then
            echo "错误：下载地址返回了网页而非脚本，请检查网络或链接是否有效。"
            exit 1
          fi
          
          bash init_env.sh
          
          # 设置时区
          ln -sf /usr/share/zoneinfo/$TZ /etc/localtime
          echo "$TZ" > /etc/timezone

      - name: Clone Source Code
        run: |
          git clone $REPO_URL -b $REPO_BRANCH --single-branch --filter=blob:none openwrt

      - name: Apply Custom Configuration
        run: |
          [ -f $DIY_SH ] && cp $DIY_SH openwrt/
          [ -f .config ] && cp .config openwrt/ || echo "No .config"

      - name: Update & Install Feeds
        working-directory: ./openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Run DIY Script (Patch DTS)
        working-directory: ./openwrt
        run: |
          chmod +x $DIY_SH
          ./$DIY_SH

      - name: Download Packages
        working-directory: ./openwrt
        run: |
          make defconfig
          # 在容器内 root 环境必须带 FORCE_UNSAFE_CONFIGURE=1
          make download -j8 FORCE_UNSAFE_CONFIGURE=1
          find dl -size -1024c -exec rm -f {} \;

      - name: Compile Firmware
        working-directory: ./openwrt
        run: |
          echo "Using $(nproc) threads to compile"
          # 2025 编译标准
          make -j$(nproc) FORCE_UNSAFE_CONFIGURE=1 || make -j1 V=s FORCE_UNSAFE_CONFIGURE=1

      - name: Organize Files
        id: organize
        working-directory: ./openwrt
        run: |
          mkdir -p ./artifact/
          find bin/targets/ramips/mt7621/ -type f -name "*sysupgrade.bin" -exec cp -f {} ./artifact/ \;
          echo "FIRMWARE_PATH=$PWD/artifact" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date +'%Y%m%d%H%M')" >> $GITHUB_ENV

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt_Mi4A_GI_${{ env.BUILD_DATE }}
          path: ${{ env.FIRMWARE_PATH }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: Mi4A_GI_${{ env.BUILD_DATE }}
          files: ${{ env.FIRMWARE_PATH }}/*
